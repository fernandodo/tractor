# å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æœ‰ç•Œç¯å½¢é˜Ÿåˆ—

---

## ä¸€ã€é¢˜ç›®æ¦‚è¿°

æœ¬é¢˜è¦æ±‚å®ç°ä¸€ä¸ª **çº¿ç¨‹å®‰å…¨ï¼ˆthread-safeï¼‰** çš„ **æœ‰ç•Œï¼ˆboundedï¼‰** ç¯å½¢é˜Ÿåˆ—ï¼ˆcircular queueï¼‰ã€‚

### åŠŸèƒ½è¦æ±‚
- é˜Ÿåˆ—å®¹é‡å›ºå®šï¼›
- å¤šçº¿ç¨‹å®‰å…¨ï¼›
- å½“é˜Ÿåˆ— **æ»¡æ—¶ push é˜»å¡**ï¼›
- å½“é˜Ÿåˆ— **ç©ºæ—¶ pop é˜»å¡**ï¼›
- ä¸ä½¿ç”¨ç¬¬ä¸‰æ–¹å¹¶å‘åº“ï¼Œä»…ç”¨ C++11 æ ‡å‡†åº“ã€‚

---

## äºŒã€åŸç†è®²è§£

### 1. ç¯å½¢é˜Ÿåˆ—æ¦‚å¿µ
ç¯å½¢é˜Ÿåˆ—æ˜¯ä¸€ç§**é¦–å°¾ç›¸æ¥çš„å›ºå®šå®¹é‡ç¼“å†²åŒº**ï¼Œå¸¸ç”¨äºç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ã€‚  
é€šè¿‡ä¸¤ä¸ªç´¢å¼•æ§åˆ¶ï¼š
- `head`ï¼šè¯»å‡ºä½ç½®ï¼›
- `tail`ï¼šå†™å…¥ä½ç½®ï¼›
- æ¨¡è¿ç®— `(index % capacity)` å®ç°â€œç¯å½¢â€å¾ªç¯ã€‚

| çŠ¶æ€ | æ¡ä»¶è¡¨è¾¾å¼ |
|------|-------------|
| é˜Ÿåˆ—ç©º | `head == tail` |
| é˜Ÿåˆ—æ»¡ | `(tail + 1) % capacity == head` |

---

### 2. çº¿ç¨‹å®‰å…¨æœºåˆ¶
é€šè¿‡äº’æ–¥é”å’Œæ¡ä»¶å˜é‡æ§åˆ¶å¹¶å‘è®¿é—®ï¼š

| åŒæ­¥åŸè¯­ | ä½œç”¨ |
|-----------|------|
| `std::mutex` | ä¿æŠ¤å…±äº«èµ„æº |
| `std::condition_variable` | å®ç°é˜»å¡ä¸å”¤é†’ |
| `std::unique_lock` | è‡ªåŠ¨ç®¡ç†åŠ è§£é” |

#### æ“ä½œé€»è¾‘è¡¨

| æ“ä½œ | é˜Ÿåˆ—çŠ¶æ€ | è¡Œä¸º |
|------|-----------|------|
| push | é˜Ÿåˆ—æ»¡ | ç­‰å¾… `not_full` |
| push | é˜Ÿåˆ—éæ»¡ | æ’å…¥å…ƒç´  â†’ é€šçŸ¥ `not_empty` |
| pop  | é˜Ÿåˆ—ç©º | ç­‰å¾… `not_empty` |
| pop  | é˜Ÿåˆ—éç©º | å–å‡ºå…ƒç´  â†’ é€šçŸ¥ `not_full` |

---

## ä¸‰ã€å®ç°ä»£ç è¦ç‚¹

```cpp
template<typename T>
class BoundedBlockingQueue {
public:
    explicit BoundedBlockingQueue(size_t capacity)
        : buffer_(capacity), capacity_(capacity), head_(0), tail_(0), size_(0) {}

    void push(const T& item) {
        std::unique_lock<std::mutex> lock(mtx_);
        not_full_.wait(lock, [this]{ return size_ < capacity_; });

        buffer_[tail_] = item;
        tail_ = (tail_ + 1) % capacity_;
        ++size_;

        not_empty_.notify_one();
    }

    void push(T&& item) {
        std::unique_lock<std::mutex> lock(mtx_);
        not_full_.wait(lock, [this]{ return size_ < capacity_; });

        buffer_[tail_] = std::move(item);
        tail_ = (tail_ + 1) % capacity_;
        ++size_;

        not_empty_.notify_one();
    }

    T pop() {
        std::unique_lock<std::mutex> lock(mtx_);
        not_empty_.wait(lock, [this]{ return size_ > 0; });

        T item = std::move(buffer_[head_]);
        head_ = (head_ + 1) % capacity_;
        --size_;

        not_full_.notify_one();
        return item;
    }

private:
    std::vector<T> buffer_;
    size_t capacity_;
    size_t head_;
    size_t tail_;
    size_t size_;
    std::mutex mtx_;
    std::condition_variable not_full_;
    std::condition_variable not_empty_;
};
```

---

## å››ã€æ€§èƒ½ä¸æ”¹è¿›

| æ”¹è¿›æ–¹å‘ | æ€è·¯ |
|-----------|------|
| éé˜»å¡æ¥å£ | å¢åŠ  `try_push()` / `try_pop()` |
| è¶…æ—¶ç­‰å¾… | ä½¿ç”¨ `wait_for()` |
| ä¼˜é›…é€€å‡º | è®¾ç½® `shutdown_` æ ‡å¿—å¹¶å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ |
| æ€§èƒ½ä¼˜åŒ– | å‡å°‘é”ç²’åº¦ï¼Œä½¿ç”¨è¿ç»­å†…å­˜æé«˜ç¼“å­˜å‘½ä¸­ç‡ |

---

## äº”ã€ç¤ºä¾‹æµ‹è¯•

```cpp
BoundedBlockingQueue<int> queue(5);

std::thread producer([&]{
    for (int i = 0; i < 10; ++i) queue.push(i);
});

std::thread consumer([&]{
    for (int i = 0; i < 10; ++i)
        std::cout << "pop: " << queue.pop() << std::endl;
});

producer.join();
consumer.join();
```

è¾“å‡ºä¸ºæœ‰åºçš„ 0â€“9ï¼Œä¸”ä¸ä¼šå‡ºç°æ•°æ®ä¸¢å¤±æˆ–æ­»é”ã€‚

---

## å…­ã€è§†é¢‘é“¾æ¥ä¸æ—¶é—´çº¿

### ğŸ“º è§†é¢‘é“¾æ¥
[å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æœ‰ç•Œç¯å½¢é˜Ÿåˆ—ï¼ˆBilibiliï¼‰](https://www.bilibili.com/video/BV1z8WbzZESA?spm_id_from=333.788.videopod.episodes&p=7)

### ğŸ•’ æ—¶é—´çº¿æ¦‚è¦

| æ—¶é—´æ®µ | å†…å®¹ |
|--------|------|
| 0:00â€“0:10 | é¢˜ç›®ä»‹ç»ä¸è¦æ±‚è¯´æ˜ |
| 0:22â€“0:46 | ç¯å½¢ç»“æ„å®šä¹‰ä¸å®ç°æ€è·¯ |
| 2:18â€“2:45 | æ¡ä»¶å˜é‡è®¾è®¡ |
| 3:56â€“5:34 | push æ“ä½œè¯¦ç»†å®ç° |
| 5:40â€“6:19 | pop æ“ä½œå®ç° |
| 8:12â€“9:18 | æµ‹è¯•ä¸æ€»ç»“ |

---

## ä¸ƒã€ä¸ºä»€ä¹ˆç”¨ `vector` è€Œä¸ç”¨ `deque`

### 1ï¸âƒ£ è®¾è®¡å‡ºå‘ç‚¹ä¸åŒ
- `std::vector`ï¼šè¿ç»­å†…å­˜ã€å›ºå®šå®¹é‡ã€éšæœºè®¿é—®é«˜æ•ˆï¼›
- `std::deque`ï¼šåˆ†æ®µå†…å­˜ã€å¯åŠ¨æ€æ‰©å®¹ã€åŒç«¯æ’å…¥å¿«ã€‚

ç¯å½¢é˜Ÿåˆ—çš„æ ¸å¿ƒæ˜¯â€œå›ºå®šå®¹é‡ + å¾ªç¯å¤ç”¨â€ï¼Œ  
è€Œä¸æ˜¯â€œåŠ¨æ€å¢é•¿çš„é˜Ÿåˆ—â€ï¼Œå› æ­¤ `vector` æ›´è‡ªç„¶ã€‚

### 2ï¸âƒ£ å†…å­˜è¿ç»­æ€§ä¸æ€§èƒ½
- `vector` å†…å­˜è¿ç»­ â†’ ç¼“å­˜å‘½ä¸­ç‡é«˜ï¼›
- `deque` å†…éƒ¨åˆ†æ®µï¼Œè®¿é—®éœ€é¢å¤–è®¡ç®—åç§»ï¼›
- å¤šçº¿ç¨‹åœºæ™¯ä¸­è¿ç»­å†…å­˜æ›´å®¹æ˜“ä¿è¯æ€§èƒ½ç¨³å®šã€‚

### 3ï¸âƒ£ æ§åˆ¶æƒä¸ç¡®å®šæ€§
- `vector` çš„å®¹é‡å›ºå®šï¼Œä¸ä¼šåŠ¨æ€åˆ†é…ï¼›
- `deque` çš„ `push_back()` å¯èƒ½é‡æ–°åˆ†é…å†…å­˜å—ï¼›
- å¯¹é”ä¿æŠ¤åŒºåŸŸæ›´éš¾é¢„æµ‹ï¼Œå¯èƒ½å¼•å‘æ€§èƒ½æŠ–åŠ¨ã€‚

### âœ… æ€»ç»“å¯¹æ¯”

| ç‰¹æ€§ | `vector` | `deque` |
|------|-----------|----------|
| å†…å­˜è¿ç»­ | âœ… | âŒ |
| å¯æ§å®¹é‡ | âœ… | âŒ |
| æ”¯æŒæ¨¡ç´¢å¼•å¾ªç¯ | âœ… | âŒ |
| åŠ¨æ€æ‰©å®¹ | âŒ | âœ… |
| é€‚åˆç¯å½¢ç¼“å†²åŒº | âœ… | âš ï¸ ä¸è‡ªç„¶ |

ç»“è®ºï¼š  
> å®ç°ç¯å½¢é˜Ÿåˆ—åº”ä½¿ç”¨ `std::vector` æˆ– `std::array`ï¼Œ  
> å› ä¸ºå®ƒä»¬æä¾›ç¨³å®šçš„å›ºå®šå®¹é‡ä¸é«˜è®¿é—®æ€§èƒ½ã€‚

---

## å…«ã€C++ æ˜¯å¦æœ‰ç¯å½¢é˜Ÿåˆ—å®¹å™¨ï¼Ÿ

æ ‡å‡† C++ **æ²¡æœ‰** æä¾›å†…ç½®çš„ç¯å½¢é˜Ÿåˆ—å®¹å™¨ã€‚  
ä½†æœ‰å‡ ç§å¯é€‰æ–¹æ¡ˆï¼š

| å®ç°æ–¹å¼ | æ˜¯å¦æ ‡å‡†åº“ | ç‰¹ç‚¹ |
|-----------|--------------|------|
| è‡ªå®šä¹‰ï¼ˆvector + ç´¢å¼•ï¼‰ | âœ… | æœ€çµæ´»ï¼Œå›ºå®šå®¹é‡ï¼Œçº¿ç¨‹å®‰å…¨å¯æ§ |
| `boost::circular_buffer` | âŒ | æˆç†Ÿç¨³å®šï¼Œè¡Œä¸ºç±»ä¼¼ STL å®¹å™¨ |
| `std::deque` | âœ… | åŠ¨æ€æ‰©å®¹ï¼Œå¯æ¨¡æ‹Ÿä½†éçœŸæ­£ç¯å½¢ |
| `std::array` + æ¨¡è¿ç®— | âœ… | æ— åŠ¨æ€åˆ†é…ï¼ŒåµŒå…¥å¼å¸¸ç”¨ |
| ä½å±‚è£¸å®ç° | âœ… | é«˜æ€§èƒ½é€šä¿¡ç¼“å†²åŒºæ–¹æ¡ˆ |

æ¨èï¼š
- è‹¥å…è®¸ç¬¬ä¸‰æ–¹åº“ â†’ ä½¿ç”¨ **Boost.CircularBuffer**ï¼›
- è‹¥è¿½æ±‚æ§åˆ¶ä¸æ€§èƒ½ â†’ ç”¨ `vector` è‡ªè¡Œå®ç°ï¼›
- è‹¥ç”¨äºåµŒå…¥å¼ â†’ ä½¿ç”¨ `std::array` å›ºå®šå­˜å‚¨ã€‚

---

## ä¹ã€æ€»ç»“

1. `vector` + æ¡ä»¶å˜é‡ = é«˜æ•ˆå¯æ§çš„ç¯å½¢é˜Ÿåˆ—å®ç°ï¼›
2. `deque` é€‚åˆé€šç”¨é˜Ÿåˆ—ï¼Œä¸é€‚åˆå›ºå®šå®¹é‡ï¼›
3. æ ‡å‡†åº“æ— ç¯å½¢å®¹å™¨ï¼ŒBoost æä¾› `circular_buffer`ï¼›
4. ç†è§£ç´¢å¼•å¾ªç¯ä¸åŒæ­¥æœºåˆ¶æ˜¯å…³é”®ã€‚

> **æ ¸å¿ƒæ€è·¯**ï¼š  
> ç”¨å›ºå®šå®¹é‡è¿ç»­å†…å­˜æ¨¡æ‹Ÿâ€œå¾ªç¯â€æ•ˆæœï¼Œ  
> é€šè¿‡é”ä¸æ¡ä»¶å˜é‡åè°ƒç”Ÿäº§ä¸æ¶ˆè´¹ã€‚

---
